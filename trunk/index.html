<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
 <HEAD>
  <TITLE>SNMP support for Perl 5</TITLE>
 </HEAD>
 <BODY bgcolor="#ffffff">
<DIV ALIGN=CENTER>
  <H1>SNMP support for Perl 5</H1>

  <p> Copyright (c) 1995-2000, Simon Leinen<br>
  All rights reserved </p>

  <em> This program is free software; you can redistribute it under
  the <a href="http://language.perl.com/misc/Artistic.html">"Artistic
  License"</a> included in this distribution. </em>

  <p>Author: <A HREF="http://www.switch.ch/misc/leinen/">Simon
Leinen</A> &lt;<A
HREF="mailto:simon@switch.ch">simon@switch.ch</A>&gt;</p>

</DIV>

<P> This package contains Perl 5 modules <tt>SNMP_Session.pm</tt> and
 <tt>BER.pm</tt>, which, when used together, provide rudimentary
 access to remote <a
 href="http://www.switch.ch/misc/leinen/snmp/">SNMP</a> (v1/v2)
 agents.  It can be downloaded from the FTP directory <a
 href="ftp://ftp.switch.ch/software/sources/network/snmp/perl/">ftp://ftp.switch.ch/software/sources/network/snmp/perl/</a>.
 </P>

<H2>Features</H2>

<P> This module differs from existing SNMP packages in that it is
 completely stand-alone, i.e. you don't need to have another SNMP
 package such as CMU SNMP.  It is also written entirely in Perl, so
 you don't have to compile any C modules.  It uses the Perl 5
 <SAMP>Socket.pm</SAMP> module and should therefore be very
 portable, even to non-Unix systems. </P>

<p> The SNMP operations currently supported are "get", "get-next",
 "get-bulk" and "set", as well as trap generation and reception. </p>

<p> For an excellent example of the type of application this is useful
 for, see Tobias Oetiker's <a
 href="http://ee-staff.ethz.ch/~oetiker/webtools/mrtg/mrtg.html">``mrtg''
 (Multi Router Traffic Grapher)</a> tool </p>

<h2> Recent Changes: </h2>

<ul>

<li> SNMP_Session.pm 0.78: The <tt>map_table</tt> implementation for
SNMPv2 sessions has been completely rewritten to reliably support
tables with holes in them.  Note that this hasn't been completely
validated or tested yet, but at least it has been found to handle
common cases reasonably. </li>

<li> BER.pm 0.77: Added support for long integers, so that
<tt>Counter64</tt> values can be handled without risk of losing
precision (due to automatic coercion to floating-point representation
by Perl).  When a BER-encoded integer is so long that it might not fit
in a 32-bit unsigned integer, then we use <tt>Math::BigInt</tt>
arithmetics to convert it. <b>Warning:</b> code which calls the
decoding functions should be prepared to handle <tt>Math::BigInt</tt>
values if <tt>Counter64</tt> values can be accessed.  In most respect,
those long integers behave just like ordinary integers.  A notable
exception is that they print with a leading ``<tt>+</tt>'' sign. </li>

<li> SNMP_Session 0.77: The SNMPv2 implementation of
<tt>map_table_start_end</tt> has been enhanced to cope with the case
where a response PDU ends with a truncated table row, courtesy <a
href="mailto:pee@gblx.net">Paul E. Erkkila</a>.  Note that tables with
missing entries still aren't handled correctly when SNMPv2 (and thus
the <tt>get-bulk</tt> operator is used). </li>

<li> SNMP_util 0.73: Added a fix from <a
href="mailto:mcm@unx.sas.com">Mike Mitchell</a> (originally <a
href="demel@zid.tuwien.ac.at">Johannes Demel</a>) to treat
<tt>OBJECT-IDENTITY</tt> like <tt>OBJECT IDENTIFIER</tt>.

<li> SNMP_Session 0.76: Added some debugging support for
<tt>map_table</tt>, which still doesn't work reliably when the SNMPv2
<tt>get-bulk</tt> operator is used. </li>

<li> <tt>test/if-counters.pl</tt>: Added <samp>-c</samp> option to
enable Cisco-specific variables (which are no longer retrieved by
default as in previous versions). </li>

<li> SNMP_Session 0.75: Fixed a bug in versions 0.73-0.74 where
creation of trap listener sockets would fail.  Rather than using
<tt>bind</tt> to bind to the trap port, we now pass a
<tt>LocalPort</tt> argument to <tt>INET-&gt;new</tt>. </li>

<li> SNMP_Session 0.75: Parse SNMPv2-Trap-Requests in addition to
SNMPv1 ones.  A caller can tell whether an SNMPv1 or an SNMPv2 request
has been received by testing whether the SNMPv1-specific fields are
defined.  The sample script <tt>test/trap-listener</tt> has been
updated to understand SNMPv2 Traps. </li>

<li> SNMP_Session 0.75: New subroutine <tt>v2_trap_request_send</tt>
which sends SNMPv2 Trap PDUs.  The sample script
<tt>test/trap-send</tt> has been extended to generate either type of
trap on request. </li>

<li> SNMP_Session 0.74: Put under copyright and Artistic
License. </li>

<li> SNMP_util 0.72: Changed <tt>snmpgetnext</tt> so it will return
the next lexicographical larger OID number, even if it is not in the
same OID tree.  Before the change snmpget would discard the return
value if the OID wasn't in the same tree.  In <tt>snmpMIB_to_OID</tt>,
an "unitialized variable" warning was removed. (Changes by <a
href="mailto:mcm@unx.sas.com">Mike Mitchell</a>, the author) </li>

<li> SNMP_Session 0.73: The UDP socket associated with each SNMP
session object is now created using <tt>IO::Socket::INET-&gt;new</tt>.
Before this change, a Perl file descriptor name was generated for each
new socket.  Apparently this caused a file descriptor leak.  The new
code is much cleaner and doesn't have that problem anymore.  Hopefully
the newly introduced dependency on the Socket::IO module is not a
problem.  Thanks to <a href="mailto:elble@icculus.nsg.nwu.edu">Andrew
W. Elble</a> for suggesting this change. </li>

<li> BER.pm 0.72: A new variable,
<tt>$BER::pretty_print_timeticks</tt>, has been introduced to give
users control over the degree of pretty-printing of <tt>TimeTicks</tt>
values.  If left at the defaults, <tt>TimeTicks</tt> values will be
converted to strings such as <samp>14&nbsp;days,&nbsp;6:56:07</samp>.  If you
set it to zero, the same value will simply pretty-print as
<samp>123456789</samp>, which should be interpreted in units (ticks)
of 10ms. </li>

<li> SNMP_util.pm 0.71: New subroutines <tt>snmpLoad_OID_Cache</tt> and
<tt>snmpQueue_MIB_File</tt> for loading MIBs in compact format. </li>

<li> SNMP_util.pm 0.71: <tt>snmpset</tt> now accepts <tt>ipaddr</tt>
as a type specifier. </li>

<li> SNMP_util.pm 0.70: <a href="mailto:mcm@unx.sas.com">Mike
Mitchell</a> added code for parsing MIB files.  See the description of
<tt>snmpMIB_to_OID</tt> in <a
href="README.SNMP_util"><tt>README.SNMP_util</tt></a>. </li>

<li> SNMP_util.pm 0.69: Enable parsing of community strings which
contain <samp>@</samp> characters. </li>

<li> SNMP_util.pm 0.58: Check for errors from <tt>encode_oid</tt>, so
that illegal OIDs generate error messages.  Allow for suppression of
warnings by setting <tt>$SNMP_Session::suppress_warnings</tt> to a
value greater than one. </li>

<li> SNMP_Session.pm 0.68: Added methods <tt>receive_request</tt> and
<tt>decode_request</tt> to support SNMP agents.  Contributed by <a
href="mailto:mikem@open.com.au">Mike McCauley</a>. </li>

<li> SNMP_Session.pm 0.67: Implement a <tt>map_table_start_end</tt>
method for <tt>SNMPv2c_Session</tt> which uses <tt>get-bulk</tt>.  See
<a href="#map-table-4-use">Walking Tables With <tt>get-bulk</tt></a>
for more information. </li>

<li> SNMP_Session.pm 0.66: Fix from <a
href="mailto:Alan.Nichols@Ebay.Sun.COM">Alan Nichols</a> to the
handling of error replies.  In the last few revisions of SNMP_Session,
requests to which the agent responded with a non-zero
<tt>errorStatus</tt> were erroneously retried. </li>

<li> SNMP_Session.pm 0.66: When the <tt>errorStatus</tt> is zero, we
don't care about the <tt>errorIndex</tt>.  This makes us liberal
enough to cope with very old versions of the CMU agent code which
sometimes put a non-zero <tt>errorIndex</tt> in normal response
packets. </li>

<li> BER.pm 0.66: Changed the <tt>$VERSION</tt> number to be in line
with SNMP_Session.pm's. </li>

<li> BER.pm 0.66: Changed <tt>encode_oid</tt> so that it signals an
error when passed an illegal Object ID, such as one whose first subid
isn't 0, 1 or 2.  This should help people who try to use output from
CMU/UCD SNMP directly in MRTG. </li>

<li> SNMP_Session.pm 0.65: Fix error message when binding to UDP port
fails (<a href="mailto:jzhukovs@staff.juno.com">Jonathan
Zhukovsky</a>). </li>

<li> SNMP_util.pm 0.57: Small change to avoid warnings with "-w" when
session parameters are defaulted. </li>

<li> SNMP_util.pm 0.56: New subroutine <tt>snmpmapOID</tt>, <a
href="mailto:mcm@unx.sas.com">Mike Mitchell</a>. </li>

<li> SNMP_Session.pm 0.64: Fix of a bug in the detection of missing
responses by <a href="mailto:mcm@unx.sas.com">Mike Mitchell</a>. </li>

<li> SNMP_Session.pm 0.63: Fixed response matching logic to ignore
 out-of-sequence responses.  This has been a long-standing bug which
 made it very hard to use a single session object for multiple queries
 to devices that are (sometimes) slow in responding. </li>

<li> SNMP_Session.pm 0.62: Scoping problem with pretty_address()
 fixed. </li>

<li> Makefile.PL: New file which allows for easy installation
 according to standard Perl convention.  Kudos to <a
 href="mailto:clintdw@netcom.com">Clinton Wong</a>. </li>

<li> SNMP_Session.pm 0.61: The sender address of the last response
 received for a session is stored in
 <em>$session-&gt;{'last_sender_addr'}</em>.  In connection with
 broadcast or multicast addresses, this can be used to discover SNMP
 agents listening to specific communities, as illustrated in
 <tt>test/discover</tt>. </li>

<li> SNMP_Session.pm 0.60: Added support for <a
 href="#trap-recv">receiving SNMPv1 traps</a>. </li>

<li> SNMP_session.pm 0.59: Added methods <tt>set_timeout</tt>,
 <tt>set_retries</tt>, and <tt>set_backoff</tt> that can be used to
 tune the retransmission algorithm.  Fixed a bug in <tt>map_table</tt>
 that would cause an index of "0" to terminate the table walk. </li>

<li> SNMP_util.pm 0.54: First version to be distributed with the
 package, courtesy <a href="mailto:mcm@unx.sas.com">Mike
 Mitchell</a>. </li>

<li> BER.pm 0.58: Added <tt>encode_timeticks()</tt> subroutine.  This
 was used in the sample script for <a href="#trap-send">sending
 traps</a>, but was only defined in <tt>test/trap-test.pl</tt>.
 Thanks to <a href="mailto:bergerg@att.net">Gary Berger</a> for
 noticing this. </li>

<li> BER.pm 0.57: Added <tt>encode_ip_address()</tt> subroutine on a
 suggestion by <a href="mailto:mdiehn@mindspring.net">Mike
 Diehn</a>. </li>

<li> SNMP_Session 0.58: Added support for generating traps, courtesy
 <a href="mailto:mcm@unx.sas.com">Mike Mitchell</a>, see <a
 href="#trap-send">Sending Traps</a>. </li>

<li> <tt>test/ber-test.pl</tt>: Added more test cases contributed by
 <a href="mailto:mcm@unx.sas.com">Mike Mitchell</a>. </li>

<li> SNMP_Session 0.57: table walking support See ``<a
 href="#map-table-use">Walking Tables</a>'' below for how this is
 used. </li>

<li> BER 0.56: New <tt>encode_int()</tt> subroutine contributed by <a
href="mailto:mcm@unx.sas.com">Mike Mitchell</a>.  Fixes incorrect
encoding in the range +-2^15-2^23 and generalized to integers of any
size. </li>

<li> BER 0.55: Fix an arithmetic bug in the uptime
pretty-printer. Kudos to <a href="mailto:niels@euro.net">Niels
Bakker</a> for noticing this. </li>

<li> SNMP_Session 0.56: Fix a bug which occurs when an error should be
signaled while an SNMPv1_Session is being opened.  Noticed by <a
href="mailto:dcox@lexmark.com">Dan Cox</a> and <a
href="mailto:pakhomenko@gmd.de">Iouri Pakhomenko</a>. </li>

<li> BER 0.52: Ignore a leading dot when encoding an OID.  This is to
avoid trouble when people cut&amp;paste OIDs from CMU/UCD SNMP, where
a leading dot is used to mark a "fully qualified" OID. </li>

<li> SNMP_Session 0.55: The SNMP_Session module no longer calls
<tt>warn</tt> when the variable
<tt>$SNMP_Session::suppress_warnings</tt> is set to non-zero (it is
zero by default).  The error message from SNMP_Session can be
retrieved as <tt>$SNMP_Session::errmsg</tt>. </li>

<li> SNMP_Session 0.54, BER.pm 0.51: Errors in the BER module are now
passed upwards by the SNMP_Session module.  Before this change, one
could not distinguish malformed SNMP responses from no response at
all.  The BER module now no longer calls die(), but returns undefined
values. </li>

<li> Added <tt>test/arp</tt> which prints the NetToMedia table from a
remote host. </li>

<li> SNMP_Session 0.53: Avoid passing numeric IP addresses to
<tt>inet_ntoa()</tt>, by <a href="mailto:dan_needles@INS.COM">Daniel
L. Needles</a> </li>

<li> SNMP_Session 0.52: setRequest support based on code contributed
by <a href="mailto:matter@media.mit.edu">Matthew Trunnell</a>.  See
``<a href="#set-req-use">Set Requests</a>'' below for how this is
used. </li>

<li> SNMP_Session 0.51: Improved error messages by printing the
session in error messages if possible, and the OID and error message
whenever the agent sends back an error. </li>

<li> SNMP_Session 0.50, BER 0.50: The <b>BER</b> and
<b>SNMP_Session</b> modules both have version numbers according to the
convention in <b>Exporter.pm</b>.  That is, you can now insist on a
minimal version of the modules by saying e.g.

<pre>
use BER "0.50";
use SNMP_Session "0.52";
</pre>

 The initial version numbers are 0.50 for both modules. </li>

<li> The pretty printer should now print unsigned 32-bit values (such
 as Counters and Gauges) correctly, i.e. values larger than
 2<sup><font size="-2">31</font></sup> are printed as large positive
 numbers rather than negative numbers.  Note that this can cause
 problems depending on how you handle the output of the pretty
 printer, since those string representations of large numbers may not
 be convertible to integers using <b>atoi()</b> or similar
 functions. </li>

<li> The subroutines in SNMP_Session never call <b>die()</b> anymore
 if it encouters error situations.  Instead, they issue a warning and
 return <b>undef</b>.  <a href="mailto:btr@iol.unh.edu">Brad
 Ritchie</a> managed to convince me that library code should never
 <b>die</b>.  Unfortunately I haven't revised <b>BER.pm</b> yet, so
 subroutines related with BER transfer syntax encoding and decoding
 may still <b>die</b>. </li>

<li> The code has been cleaned up to use more of the standard
 functionality of the Perl 5 <b>Socket.pm</b> module.  That should
 have eliminated some potential portability problems (and delegated
 responsability for potential bugs :-).  Note that this means that the
 code requires Perl 5.002 or later. </li>

<li> Both source files now make extensive use of <b>strict</b> for
 better compile-time error checking.  Please notify me in case you
 have any problems because of this. </li>

<li> The library now attempts to retransmit queries for which no
 reponse has been received during a given time.  The default
 parameters for the retransmission logic have been discussed at length
 in the <em>mrtg</em> mailing list, and seem to work quite well, both
 against overloaded routers that simply drop some SNMP requests and
 against routers that are behind slow or lossy links.  If you have
 feedback on the default parameters, please drop me an e-mail. </li>

<li> When I implemented the retransmission logic, I also fixed
 handling of request IDs.  In older versions, the request ID was never
 changed between reqeuest, which could lead to (late) resposes being
 associated with the wrong request.  Now the request ID is incremented
 for each request, and mismatching responses are ignored.  For
 retransmissions, the request ID isn't changed.  If we did change it,
 we could estimate response time and implement an adaptive
 retransmission algorithm.  This has been left for further
 study. </li>

<li> Added code contributed by <em>mrtg</em> users:

 <ul>

  <li> Encoding of larger subids, by <a
 href="mailto:sip00@vg.swissptt.ch">Philippe Simonet</a> and <a
 href="mailto:yhu@casc.com">Yufang HU</a> </li>

  <li> Decoding <b>sysUpTime</b>, by <a
 href="mailto:dlr@Bungi.com">Dave Rand</a> </li>

  <li> Decoding longer (unsigned) integers, by <a
 href="mailto:oetiker@ee.ethz.ch">Tobias Oetiker</a> </li>

  <li> Decoding longer strings, by <a
 href="mailto:san@iem.pw.edu.pl">Andrzej Tobola</a> </li>

  <li> More reasonable socket initialization, by <a
 href="mailto:peters@dkrz.de">Heine Peters</a> </li>

  <li> Correct integer BER-encoding, by <a
 href="mailto:mcm@unx.sas.com">Mike Mitchell</a> </li>

 </ul> </li>

</ul>

<H2>Usage</H2>

<P> The basic usage of these routines works like this: </P>

<PRE>
use BER;
require 'SNMP_Session.pm';

# Set $host to the name of the host whose SNMP agent you want
# to talk to.  Set $community to the community name under
# which you want to talk to the agent.	Set port to the UDP
# port on which the agent listens (usually 161).

$session = SNMP_Session-&gt;open ($host, $community, $port)
    || die "couldn't open SNMP session to $host";

# Set $oid1, $oid2... to the BER-encoded OIDs of the MIB
# variables you want to get.

if ($session-&gt;get_request_response ($oid1, $oid2, ...)) {
    ($bindings) = $session-&gt;decode_get_response ($session-&gt;{pdu_buffer});

    while ($bindings ne '') {
	($binding,$bindings) = &amp;decode_sequence ($bindings);
	($oid,$value) = &amp;decode_by_template ($binding, "%O%@");
	print $pretty_oids{$oid}," =&gt; ",
	      &amp;pretty_print ($value), "\n";
    }
} else {
    die "No response from agent on $host";
}
</PRE>

<H2>Encoding OIDs</H2>

<P> In order to BER-encode OIDs, you can use the function
<B>BER::encode_oid</B>.  It takes (a vector of) numeric subids as an
argument.  For example, </P>

<PRE>
use BER;
encode_oid (1, 3, 6, 1, 2, 1, 1, 1, 0)
</PRE>

<P> will return the BER-encoded OID for the <B>sysDescr.0</B>
 (1.3.6.1.2.1.1.1.0) instance of <A
 HREF="ftp://ftp.isi.edu/in-notes/rfc1213.txt">MIB-2</A>. </P>

<H2>Decoding the results</H2>

<P> When get_request_response returns success, you must decode the
 response PDU from the remote agent.  The function
 <B>decode_get_response</B> can be used to do this.  It takes a
 get-response PDU, checks its syntax and returns the <EM>bindings</EM>
 part of the PDU.  This is where the remote agent actually returns the
 values of the variables in your query. </P>

<P> You should iterate over the individual bindings in this
 <EM>bindings</EM> part and extract the value for each variable.  In
 the example above, the returned bindings are simply printed using the
 <B>BER::pretty_print</B> function.  The hash <B>%pretty_oids</B> in
 the example contains a mapping from BER-encoded OIDs to "readable"
 instance names.  Look at the source of the real example programs to
 see how this is constructed. </P>

<H2><a name="set-req-use">Set Requests</a></H2>

<p> Set requests are generated much like get or getNext requests are,
 with the exception that you have to specify not just OIDs, but also
 the values the variables should be set to.  Every binding is passed
 as a reference to a two-element array, the first element being the
 encoded OID and the second one the encoded value.  See the
 <tt>test/set-test.pl</tt> script for an example, in particular the
 subroutine <tt>snmpset</tt>. </p>

<H2><a name="map-table-use">Walking Tables</a></H2>

<p> Beginning with version 0.57 of <tt>SNMP_Session.pm</tt>, there is API
 support for walking tables.  The <tt>map_table</tt> method can be
 used for this as follows: </p>

<pre>
sub walk_function ($$$) {
  my ($index, $val1, $val3) = @_;
  ...
}

...
$columns = [$base_oid1, $base_oid3];
$n_rows = $session-&gt;map_table ($columns, \&amp;walk_function);
</pre>

<p> The <em>columns</em> argument must be a reference to a list of
 OIDs for table columns sharing the same index.  The method will
 traverse the table and call the <em>walk_function</em> for each row.
 The arguments for these calls will be:

<ol>

<li> the <em>row index</em> as a partial OID in dotted notation,
 e.g. "1.3", or "10.0.1.34".

<li> the values of the requested table columns in that row, in
 BER-encoded form.  If you want to use the standard
 <tt>pretty_print</tt> subroutine to decode the values, you can use
 the following idiom:

<pre>
  grep (defined $_ &amp;&amp; ($_=pretty_print $_), ($val1, $val3));
</pre>

</ol>

<H3><a name="map-table-4-use">Walking Tables With
<tt>get-bulk</tt></a></H3>

<p> Since version 0.67, <tt>SNMP_Session</tt> uses a different
<tt>get_table</tt> implementation for <tt>SNMPv2c_Session</tt>s.  This
version uses the ``powerful <tt>get-bulk</tt> operator'' to retrieve
many table rows with each request.  In general, this will make table
walking much faster under SNMPv2c, especially when round-trip times to
the agent are long. </p>

<p> There is one difficulty, however: With <tt>get-bulk</tt>, a
management application can specify the maximum number of rows to
return in a single response.  <tt>SNMP_Session.pm</tt> provides a new
function, <tt>map_table_4</tt>, in which this <tt>maxRepetitions</tt>
value can be specified explicitly. </p>

<p> For maximum efficiency, it should be set to a value that is one
greater than the number of rows in the table.  If it is smaller, then
<tt>map_table</tt> will use more request/response cycles than
necessary; if it is bigger, the agent will have to compute variable
bindings beyond the end of the table (which <tt>map_table</tt> will
throw away). </p>

<p> Of course it is usually impossible to know the size of the table
in advance.  If you don't specify <tt>maxRepetitions</tt> when walking
a table, then <tt>map_table</tt> will use a per-session default
(<tt>$session-&gt;default_max_repetitions</tt>).  The default value for
this default is 12. </p>

<p> If you walk a table multiple times, and the size of the table is
relatively stable, you should use the return value of
<tt>map_table</tt> (which is the number of rows it has encountered) to
compute the next value of <tt>maxRepetitions</tt>.  Remember to add
one so that <tt>map_table</tt> notices when the table is finished!
</p>

<p> Note that for really big tables, this doesn't make a big
difference, since the table won't fit in a single response packet
anyway. </p>

<H2><a name="trap-send">Sending Traps</a></H2>

<p> To send a trap, you have to open an SNMP session to the trap
 receiver.  Usually this is a process listening to UDP port 162 on a
 network management station.  Then you can use the
 <tt>trap_request_send</tt> method to encode and send SNMPv1 traps.
 There is no way to find out whether the trap was actually received at
 the management station - SNMP traps are fundamentally unreliable.
</p>

<p> When constructing an SNMPv1 trap, you must provide

<ul>

<li> the "enterprise" Object Identifier for the entity that generates
 the trap

<li> your IP address

<li> the generic trap type

<li> the specific trap type

<li> the sysUpTime at the time of trap generation

<li> a sequence (may be empty) of variable bindings further describing 
 the trap.

</ul>

<p> For SNMPv2 traps, you need:

<ul>

<li> the trap's OID

<li> the sysUpTime at the time of trap generation

<li> the bindings list as above

</ul>

<p> For SNMPv2 traps, the uptime and trap OID are encoded as bindings
which are added to the front of the other bindings you provide. </p>

<p> Here is a short example: </p>

<pre>
my $trap_receiver = "netman.noc";
my $trap_community = "SNMP_Traps";
my $trap_session = $version eq '1'
    ? SNMP_Session-&gt;open ($trap_receiver, $trap_community, 162)
    : SNMPv2c_Session-&gt;open ($trap_receiver, $trap_community, 162);
my $myIpAddress = ...;
my $start_time = time;

...

sub link_down_trap ($$) {
  my ($if_index, $version) = @_;
  my $genericTrap = 2;		# linkDown
  my $specificTrap = 0;
  my @ifIndexOID = ( 1,3,6,1,2,1,2,2,1,1 );
  my $upTime = int ((time - $start_time) * 100.0);
  my @myOID = ( 1,3,6,1,4,1,2946,0,8,15 );

  warn "Sending trap failed"
    unless ($version eq '1')
	? $trap_session-&gt;trap_request_send (encode_oid (@myOID),
					    encode_ip_address ($myIpAddress),
					    encode_int ($genericTrap),
					    encode_int ($specificTrap),
					    encode_timeticks ($upTime),
					    [encode_oid (@ifIndex_OID,$if_index),
					     encode_int ($if_index)],
					    [encode_oid (@ifDescr_OID,$if_index),
					     encode_string ("foo")])
	    : $trap_session-&gt;v2_trap_request_send (\@linkDown_OID, $upTime,
						   [encode_oid (@ifIndex_OID,$if_index),
						    encode_int ($if_index)],
						   [encode_oid (@ifDescr_OID,$if_index),
						    encode_string ("foo")]);
}
</pre>

<H2><a name="trap-recv">Receiving Traps</a></H2>

<p> Since version 0.60, SNMP_Session.pm supports the receipt and
 decoding of SNMPv1 trap requests.  Since version 0.75, SNMPv2 Trap
 PDUs are also recognized. </p>

<p> To receive traps, you have to create a special SNMP session that
 passively listens on the SNMP trap transport address (usually UDP
 port 162).  Then you can receive traps using the
 <tt>receive_trap</tt> method and decode them using
 <tt>decode_trap_request</tt>.  The <em>enterprise</em>,
 <em>agent</em>, <em>generic</em>, <em>specific</em> and
 <em>sysUptime</em> return values are only defined for SNMPv1 traps.
 In SNMPv2 traps, the equivalent information is contained in the
 bindings.
</p>

<pre>
my $trap_session = SNMP_Session-&gt;open_trap_session ()
  || die "cannot open trap session";
my ($trap, $sender_addr, $sender_port) = $trap_session-&gt;receive_trap ()
  || die "cannot receive trap";
my ($community, $enterprise, $agent,
    $generic, $specific, $sysUptime, $bindings)
  = $session-&gt;decode_trap_request ($trap)
    || die "cannot decode trap received"
...
my ($binding, $oid, $value);
while ($bindings ne '') {
    ($binding,$bindings) = &amp;decode_sequence ($bindings);
    ($oid, $value) = decode_by_template ("%O%@");
    print BER::pretty_oid ($oid)," =&gt; ",pretty_print ($value),"\n";
}
</pre>

<H2>Future Plans</H2>

<H3>SNMPv3 Support</H3>

<P> The code could first be restructured to follow the modularization
 proposed in <a
 href="ftp://sunsite.cnlab-switch.ch/doc/standard/rfc/22xx/2271">RFC
 2271</a> (An Architecture for Describing SNMP Management Frameworks).
 The existing SNMPv1 and SNMPv2c support must somehow be retrofitted
 to this framework.  Later, one could add support for SNMPv3 PDU
 formats and for user-based security. </p>

<H3>Higher-Level APIs</H3>

<P> The current programming interface is very close to the level of
 SNMP operations and PDUs.  For actual management applications, there
 are probably more convenient interfaces that could be defined. </P>

<HR>
<ADDRESS>
<!-- hhmts start -->
20001005
<!-- hhmts end -->
<A HREF="http://www.switch.ch/misc/leinen/">
 Simon Leinen &lt;simon.leinen@switch.ch&gt;</A>

<A HREF="http://validator.w3.org/"><IMG ALIGN=RIGHT BORDER=0
     SRC="../../images/vh40.gif"
     ALT="Valid HTML 4.0!" HEIGHT=31 WIDTH=88></A>

</ADDRESS>

</BODY>
</HTML>
